"use strict";function previousSong(){currentSong>0&&playSong(--currentSong)}function seekBackward(){player.currentTime>0&&(player.currentTime-=15)}function seekForward(){player.currentTime<player.duration&&(player.currentTime+=15)}function nextSong(){currentSong<songs.length-1&&playSong(++currentSong)}function play(){player.play().then(e=>{playBtn.children[0].classList.contains("fa-play")&&(playToggle(),playBtn.onclick=pause)})}function pause(){playBtn.children[0].classList.contains("fa-pause")&&(player.paused||(player.pause(),playToggle(),playBtn.onclick=play))}function playToggle(){playBtn.children[0].classList.toggle("fa-pause"),playBtn.children[0].classList.toggle("fa-play")}function uploadSongs(e){let t=e||window.event;if(t.target.files.length>0)for(const[e,n]of Object.entries(t.target.files))validateFile(n.name)&&notRepeated(n.name)&&(songs.push(n),listSong(formatedName(n.name)))}function validateFile(e){let t=["mp3"],n=e.substring(e.lastIndexOf(".")+1).toLowerCase();return t.includes(n)}function notRepeated(e){for(const t of songs)if(!t.name.localeCompare(e))return!1;return!0}function listSong(e){let t=document.createElement("li"),n=document.createElement("span");n.innerText=e,t.appendChild(n),t.setAttribute("id",`song${songs.length-1}`),t.addEventListener?t.addEventListener("click",pickSong,!1):t.attachEvent("onclick",pickSong),songList.appendChild(t)}function pickSong(){playSong(parseInt(this.id.substr(4)))}function playSong(e){unselectSong(),currentSong=e,lastSong=currentSong;try{reader.readAsDataURL(songs[currentSong]),document.getElementById(`song${currentSong}`).classList.add("selected");let e=formatedName(songs[currentSong].name);songView.querySelector("header > h3").innerText=e,e=e.split("-");for(let t in e)e[t]=e[t].trim();getTrackID(...e).then(t=>{t?(document.getElementById("album_name").innerText="Album: "+t.album_name,getLyrics(t.track_id).then(e=>{songLyrics.innerText=e?e.lyrics_body:"No ha sido posible localizar la letra de esta canción"})):(albumName.innerHTML="No ha sido posible extraer la información necesaria del título de la canción<br><br>El archivo requiere de una estructura ARTISTA - TITULO para poder extraer la información necesaria.",songLyrics.innerText=""),"mediaSession"in navigator&&(navigator.mediaSession.metadata.artist=e[0],e[1]&&(navigator.mediaSession.metadata.title=e[1],t&&(navigator.mediaSession.metadata.album=t.album_name)))})}catch(e){console.log("err: "+e)}}function formatedName(e){return e=e.substring(0,e.lastIndexOf(".")),e.indexOf("(")>0&&(e=e.substring(0,e.indexOf("("))),e=e.replace(/_/g," "),e}function getTrackID(e,t){return new Promise((n,a)=>{t&&(xmlHttp.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let e=JSON.parse(this.responseText).message.body.track_list;e.length>0?n(e[0].track):n("")}},xmlHttp.open("get",`https://cors-anywhere.herokuapp.com/http://api.musixmatch.com/ws/1.1/track.search?q_artist=${e}&q_track=${t}&apikey=${apiKey}`,!0),xmlHttp.send())})}function getLyrics(e){return new Promise((t,n)=>{xmlHttp.onreadystatechange=function(){4==this.readyState&&200==this.status&&t(JSON.parse(this.responseText).message.body.lyrics)},xmlHttp.open("get",`https://cors-anywhere.herokuapp.com/http://api.musixmatch.com/ws/1.1/track.lyrics.get?track_id=${e}&apikey=${apiKey}`,!0),xmlHttp.send()})}function createXMLHTTP(){let e;if(window.XMLHttpRequest)e=new XMLHttpRequest;else if(window.ActiveXObject)try{e=new ActiveXObject("MSXML2.XMLHTTP")}catch(t){e=new ActiveXObject("Microsoft.XMLHTTP")}return e}function unselectSong(){lastSong>-1&&document.getElementById(`song${lastSong}`).classList.remove("selected")}function timeFormat(e){let t=Math.floor(e/60/60);e-=60*t*60;let n=Math.floor(e/60);return e-=60*n,e=Math.floor(e),e=e>9?e:"0"+e,t>0?t+":"+(n>9?n:"0"+n)+":"+e:n+":"+e}let player,songs,currentSong,songList,reader,playBtn,songView,lastSong,xmlHttp;const apiKey="024eac067975d805c98bc0a4a3d1f857";let seekbar,duration,songLyrics,albumName;window.addEventListener("load",()=>{player=new Audio,songs=[],currentSong=-1,lastSong=currentSong,playBtn=document.getElementById("play"),songList=document.getElementById("songList"),songView=document.getElementById("songView"),reader=new FileReader,xmlHttp=createXMLHTTP(),seekbar=document.getElementById("seekbar"),duration=Array.from(document.querySelector("#seekbar-container > h3").children),songLyrics=document.getElementById("song_lyrics"),albumName=document.getElementById("album_name"),document.getElementById("btnPicker").addEventListener("click",function(){document.getElementById("songPicker").click()},!1),document.getElementById("songPicker").addEventListener("change",uploadSongs,!1),reader.addEventListener("load",function(){try{player.src=this.result,player.controls=!0,play()}catch(e){console.log("err: "+e)}},!1),player.addEventListener("ended",function(){currentSong<songs.length-1?playSong(++currentSong):playSong(currentSong=0)},!1),document.getElementById("previousSong").addEventListener("click",previousSong,!1),document.getElementById("seekBackward").addEventListener("click",seekBackward,!1),document.getElementById("seekForward").addEventListener("click",seekForward,!1),document.getElementById("nextSong").addEventListener("click",nextSong,!1),document.getElementById("reload").addEventListener("click",function(){player.duration>0&&(player.currentTime=0,play())},!1),document.getElementById("volume").addEventListener("input",function(){player.volume=this.value},!1),player.addEventListener("loadedmetadata",function(){seekbar.max=this.duration,duration[1].innerText=timeFormat(this.duration)},!1),seekbar.addEventListener("change",function(){player.currentTime=this.value},!1),seekbar.addEventListener("input",function(){duration[0].innerText=timeFormat(this.value)},!1),player.addEventListener("timeupdate",function(){seekbar.value=this.currentTime,duration[0].innerText=timeFormat(this.currentTime)},!1),"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:"",artist:"",album:"",artwork:[{src:"../imgs/mediaSession96.jpg",sizes:"96x96",type:"image/png"},{src:"../imgs/mediaSession128.jpg",sizes:"128x128",type:"image/png"},{src:"../imgs/mediaSession192.jpg",sizes:"192x192",type:"image/png"},{src:"../imgs/mediaSession256.jpg",sizes:"256x256",type:"image/png"},{src:"../imgs/mediaSession384.jpg",sizes:"384x384",type:"image/png"},{src:"../imgs/mediaSession512.jpg",sizes:"512x512",type:"image/png"}]}),navigator.mediaSession.setActionHandler("play",play),navigator.mediaSession.setActionHandler("pause",pause),navigator.mediaSession.setActionHandler("seekbackward",seekBackward),navigator.mediaSession.setActionHandler("seekforward",seekForward),navigator.mediaSession.setActionHandler("previoustrack",previousSong),navigator.mediaSession.setActionHandler("nexttrack",nextSong))});